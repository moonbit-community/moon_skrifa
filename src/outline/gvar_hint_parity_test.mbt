// Copyright 2025 International Digital Economy Academy
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

///|
/// gvar + hinted draw parity (embedded hinting loader applies gvar deltas).
///
/// The font fixture is sourced from `fontations-reference/font-test-data`.
fn gvar_test_font_avar2checker_b64() -> String {
  "AAEAAAANAIAAAwBQR0RFRsBAwBUAAAckAAAARGF2YXKAIkBEAAAHaAAAAEJjbWFwAFQBKgAAAWgAAABE" +
  "ZnZhcoOImsAAAAesAAAAOGdseWZ5VxJGAAABuAAAA25ndmFyk8kfowAAB+QAAABcaGVhZCfeveYAAADc" +
  "AAAANmhoZWEH7AKLAAABFAAAACRobXR4CF4AcQAAAVgAAAAQbG9jYQIZAgsAAAGsAAAACm1heHAEGwER" +
  "AAABOAAAACBuYW1lJXRQPgAABSgAAAHOcG9zdP/KAFYAAAb4AAAAKgABAAAAAQAAFEtyNV8PPPUAAwPo" +
  "AAAAAOLGtvQAAAAA4sbDtgAA/zgDOgMgAAAABwACAAAAAAAAAAEAAAPo/zgAyANOAAAAAAM6AAEAAAAA" +
  "AAAAAAAAAAAAAAAEAAEAAAAEAPIADQAAAAAAAQACAB4ABwAABAAAAAAAAAAB9ABdAMgAAANOABQCVAAA" +
  "AAAAAgAAAAMAAAAUAAMAAQAAABQABAAwAAAACAAIAAIAAAAgAEIAoP//AAAAIABBAKD////h/8H/YQAB" +
  "AAAAAAAAAAAAAABiAGIBqQG3AAAACgBd/zgBmgMgAAMABwALABcAHQAnACsAMQA9AEgAAEUhESEDFTM1" +
  "ByM1MycVMzUzFSM1IxUzNScVIxUzNScVMxUjFTM1MzUnIzUzJxUzNSM1JxUzFSMVMzUjNTM1AxUzBxUz" +
  "NSM3MzUBmv7DAT3zpiFkZEMiIWQhpiGFpqZCQmRCZCEhQqZCY0FCpkJCpkZGpmZGIMgD6P1WcXFQL844" +
  "Fy9QcXF6QiJkPCElIUYhPSQiaCJGgSElISElIf0RIS8hIS8hAA0AFAAiAzoCkgAlADYAPgBkAHUAiQCp" +
  "AM0A2gDgAOQA6ADxAABSJiY1ND4CNz4CNTU0JiMiBgcnPgIzMh4CFRUjNSMOAiM+AjU1DgMHDgIVFBYz" +
  "NwcjJzMXMzcWJiY1ND4CNz4CNTU0JiMiBgcnPgIzMh4CFRUjNSMOAiM+AjU1DgMHDgIVFBYzFzUzFTM2" +
  "NjMyMhcVIiYjIgYGFRUzNTc+AjU0JiYjIgYGFSM0NjYzMhYWFRQGBgcHFTMVNzU0NjY3PgI1NCYmIyIG" +
  "BgcjPgIzMhYWFRQGBgcOAgcVBiY1NDYzMhYVFAYGIwM3FzcXBwUnNxcHJzcXExU3FwcnNxc1ORgNChEV" +
  "Cw0SBw4PDxEDHQUUGQ4JFRILHQEDCxMMExEKAgkMCwMJDgkQDdo4IDggJwInRRgNChEVCw0SBw4PDxED" +
  "HQUUGQ4JFRILHQEDCxMMExEKAgkMCwMJDgkQDVsdAQUVDQMIAgIJBQoRCUZGCw4IChEKCxAJHhEeFBMd" +
  "EQkVEilcQQcNCgYJBgkNCQgOCQEeAREbERIcDwcNCQgLBAEVDAwICAwGCQWtEzNrFH/9vBN9ExN+FH3t" +
  "PBNcWhE8Ab8LFA8NEQoFAQICBQUBDQ4NCAYOEggFCxURZhUGCwcYCRAJFAEDAgEBAQUKCAsLhZqad3ed" +
  "CxQPDREKBQECAgUFAQ0ODQgGDhIIBQsVEWYVBgsHGAkQCRQBAwIBAQEFCggLCxWaGQ0OARwBCBAKXhZI" +
  "DBIQCQoPCAkRCxMcEBAaEAwWGhMrARs7AhIWDgYDCgwHCQ0HBg0LEhkNDhkQCxIOBQYLEAsCPQwICAwM" +
  "CAUJBv6pFDJrFH8BFH0UfX0UfQFTnTwSW1sSPJ0AAAEAAAAAAlQCfwADAABBESERAlT9rAJ//YECfwAA" +
  "AAAADQCiAAMAAQQJAAEAGgAAAAMAAQQJAAIADgAaAAMAAQQJAAMAPgAoAAMAAQQJAAQAGgAAAAMAAQQJ" +
  "AAUAQgBmAAMAAQQJAAYAKACoAAMAAQQJABAAGgAAAAMAAQQJABEADgAaAAMAAQQJABkAGADQAAMAAQQJ" +
  "AQAAFgDoAAMAAQQJAQEAGAD+AAMAAQQJAQIADAEWAAMAAQQJAQMACgEiAGEAdgBhAHIAMgAgAGMAaABl" +
  "AGMAawBlAHIAUgBlAGcAdQBsAGEAcgAxAC4AMAAwADAAOwBVAEsAVwBOADsAYQB2AGEAcgAyAGMAaABl" +
  "AGMAawBlAHIALQBSAGUAZwB1AGwAYQByAFYAZQByAHMAaQBvAG4AIAAxAC4AMAAwADAAOwBHAGwAeQBw" +
  "AGgAcwAgADMALgAyAC4AMgAgACgAMwAyADUAOQApAGEAdgBhAHIAMgBjAGgAZQBjAGsAZQByAC0AUgBl" +
  "AGcAdQBsAGEAcgBhAHYAYQByADIAYwBoAGUAYwBrAGUAcgBhAHYAYQByADIAIABjAGgAZQBjAGsAYQB2" +
  "AGEAcgAyACAAdwBvAHIAawBlAHIASQB0AGEAbABpAGMAUgBvAG0AYQBuAAAAAgAAAAAAAP+cADIAAAAA" +
  "AAAAAAAAAAAAAAAAAAAAAAAEAAAAAwAkACUAAAABAAMAAAAAAAAAAAAAAAAAEgABAAAADAABAAAAKAAC" +
  "AAIAAEAAQAAAAAAAQAAAAAAAQAAAAEAAQAAAAAACAAIAAAABAAIAAAAAAAIAAAAAAAAAFAAAABoAAAAC" +
  "AAEAAQAAAAwAAQAAABwAAgABAABAAEAAAAAAAAAAAAIAAQABAAAAAEAAAAAAAQAAABAAAgACABQAAAAM" +
  "QVZBUgAAAAAAAAAAAGQAAAAAAQBBVldLAAAAAAAAAAAAZAAAAAEBAQABAAAAAgACAAAAHgAEAAAAAAAm" +
  "AAAAAAAAAAwAGwAAQABAAAAAgAIADAAEAAEABAAAAQDpQP7agEACTIAAgAIADAAFAAEACwAAAIQABIGH" +
  "QQKUApSCQAKUgYcA"
}

///|
test "hint: gvar deltas applied in hinted glyf load (avar2checker gid=0)" {
  let font = golden_font(gvar_test_font_avar2checker_b64())
  let gid : @moon_skrifa.GlyphId = @moon_skrifa.GlyphId::default()
  let size = @moon_skrifa.Size::new(16.0)
  let coords : Array[@moon_skrifa.NormalizedCoord] = Array::from_fixed_array([
    16384, 0,
  ])
  let loc = @moon_skrifa.LocationRef::new(coords.op_as_view())
  let opts = Engine::Interpreter.into()
  let outlines0 = OutlineGlyphCollection::from_font(font)
  let hinter = HintingInstance::new(outlines0, size, loc, opts).unwrap()
  let outlines = OutlineGlyphCollection::from_font(font)
  let glyph = outlines.get(gid).unwrap()
  let pen = SvgPen::with_precision(3)
  glyph
  .draw(
    DrawSettings::hinted(hinter, false).with_path_style(PathStyle::FreeType),
    pen,
  )
  .unwrap()
  |> ignore
  inspect(
    pen.to_string(),
    content="M6.562,-3.203 L1.484,-3.203 L1.484,12.797 L6.562,12.797 Z M2.672,1.891 L2.672,0.078 L5.328,0.078 L5.328,1.891 Z M4.797,0.609 L3.203,0.609 L3.203,1.359 L4.797,1.359 Z M3.734,4.656 L3.734,3.766 L4.266,3.766 L4.266,4.125 L4.797,4.125 L4.797,3.375 L3.203,3.375 L3.203,4.656 L2.672,4.656 L2.672,2.844 L5.328,2.844 L5.328,4.656 Z M4.797,6.609 L4.797,5.547 L2.672,5.547 L2.672,5.016 L5.328,5.016 L5.328,6.609 Z M2.672,7.562 L2.672,7.047 L3.734,7.047 L3.734,6.453 L2.672,6.453 L2.672,5.922 L4.266,5.922 L4.266,7.047 L5.328,7.047 L5.328,7.562 Z M3.734,8.547 L3.203,8.547 L3.203,9.125 L3.734,9.125 Z M2.672,9.672 L2.672,8.000 L5.328,8.000 L5.328,8.547 L4.266,8.547 L4.266,9.672 Z M2.688,11.734 L2.688,11.203 L3.734,11.203 L3.734,10.609 L2.672,10.609 L2.672,10.078 L5.328,10.078 L5.328,10.609 L4.266,10.609 L4.266,11.203 L5.328,11.203 L5.328,11.734 Z M2.672,-0.281 L2.672,-0.812 L3.797,-0.812 L2.672,-1.562 L2.672,-2.094 L5.328,-2.094 L5.328,-1.562 L3.703,-1.562 L4.812,-0.812 L5.328,-0.812 L5.328,-0.281 Z",
  )
}
