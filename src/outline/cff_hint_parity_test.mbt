// Copyright 2025 International Digital Economy Academy
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

///|
/// CFF/CFF2 hinting parity tests ported from `fontations-reference/skrifa`.
///
/// These tests verify `Engine::Interpreter` CFF/CFF2 hinting behavior against
/// upstream reference outputs.

///|
fn cff_hint_b64_val(c : Int) -> Int? {
  if c >= 65 && c <= 90 {
    Some(c - 65)
  } else if c >= 97 && c <= 122 {
    Some(c - 97 + 26)
  } else if c >= 48 && c <= 57 {
    Some(c - 48 + 52)
  } else if c == 43 {
    Some(62)
  } else if c == 47 {
    Some(63)
  } else {
    None
  }
}

///|
fn cff_hint_b64_decode(s : String) -> Bytes {
  let out : Array[Byte] = Array::new()
  let vals : Array[Int] = Array::new()
  let n = s.length()
  for i in 0..<n {
    let c = s.code_unit_at(i).to_int()
    if c == 61 {
      vals.push(-1)
    } else {
      match cff_hint_b64_val(c) {
        None => ()
        Some(v) => vals.push(v)
      }
    }
    if vals.length() == 4 {
      let v0 = vals.at(0)
      let v1 = vals.at(1)
      let v2 = vals.at(2)
      let v3 = vals.at(3)
      out.push((((v0 << 2) | (v1 >> 4)) & 0xFF).to_byte())
      if v2 != -1 {
        out.push(((((v1 & 0x0F) << 4) | (v2 >> 2)) & 0xFF).to_byte())
        if v3 != -1 {
          out.push(((((v2 & 0x03) << 6) | v3) & 0xFF).to_byte())
        }
      }
      vals.clear()
    }
  }
  Bytes::from_array(out.op_as_view())
}

///|
fn cff_hint_golden_font(b64 : String) -> @moon_skrifa.FontRef {
  @moon_skrifa.FontRef::new(cff_hint_b64_decode(b64)).unwrap()
}

///|
fn cff_hint_font_cantarell_vf_trimmed_b64() -> String {
  "T1RUTwARAQAABAAQQ0ZGMtlqb1oAAASgAAACzUdERUYALwA5AAAHcAAAACxHUE9TRHZMdQAAB5wAAAAgR1NVQme5edsAAAe8AAAA" +
  "WkhWQVL2VtxAAAAIGAAAAFRNVkFS08zKJwAACGwAAABaT1MvMlb4c7sAAAGAAAAAYFNUQVR+CnSVAAAIyAAAAGZhdmFy9hMarAAA" +
  "CTAAAAAeY21hcAB9AM8AAAH4AAAAPGZ2YXKKnWmSAAAJUAAAAExoZWFkBraOKAAAARwAAAA2aGhlYQedAXAAAAFUAAAAJGhtdHgH" +
  "3wFXAAAB4AAAABhtYXhwAAZQAAAAAXgAAAAGbmFtZTu4XGIAAAI0AAACTHBvc3T/nwAyAAAEgAAAACAAAQAAAABNkXCiEF1fDzz1" +
  "AAMD6AAAAADF4IQtAAAAAN38eDz+pv8ABR0ESwAAAAYAAgAAAAAAAAABAAAD1/8nAAAFY/6m/N8FHQABAAAAAAAAAAAAAAAAAAAA" +
  "BgAAUAAABgAAAAQCOAGQAAUAAAK8AooAAADaArwCigAAAXEAMgEhAAACAAUDAAAAAAAAAAAAAQAAAAAAAAAAAAAAAEFCQVQAQABp" +
  "AGwC4/8nAPQD1wDZIAABnwAAAAAB4gK2AAAAIAADAfQAMgD2AEMA9gBDAPb/+QHyAFMBFgBTAAAAAgAAAAMAAAAUAAMAAQAAABQA" +
  "BAAoAAAABAAEAAEAAABs//8AAABp//8AAAABAAQAAAABAAMABAAFAAAADQCiAAMAAQQJAAAAugAAAAMAAQQJAAEAEgC6AAMAAQQJ" +
  "AAIADgDMAAMAAQQJAAMAOADaAAMAAQQJAAQAIgESAAMAAQQJAAUAGgE0AAMAAQQJAAYAIgFOAAMAAQQJAQAADAFwAAMAAQQJAQEA" +
  "CAF8AAMAAQQJAQIACgGEAAMAAQQJAQMADgDMAAMAAQQJAQQACAGOAAMAAQQJAQUAFAGWAEMAbwBwAHkAcgBpAGcAaAB0ACAAMgAw" +
  "ADEAOQAgAFQAaABlACAAQwBhAG4AdABhAHIAZQBsAGwAIABQAHIAbwBqAGUAYwB0ACAAQQB1AHQAaABvAHIAcwAgACgAaAB0AHQA" +
  "cABzADoALwAvAGcAaQB0AGwAYQBiAC4AZwBuAG8AbQBlAC4AbwByAGcALwBHAE4ATwBNAEUALwBjAGEAbgB0AGEAcgBlAGwAbAAt" +
  "AGYAbwBuAHQAcwApAEMAYQBuAHQAYQByAGUAbABsAFIAZQBnAHUAbABhAHIAMAAuADMAMAAzADsAQQBCAEEAVAA7AEMAYQBuAHQA" +
  "YQByAGUAbABsAC0AUgBlAGcAdQBsAGEAcgBDAGEAbgB0AGEAcgBlAGwAbAAgAFIAZQBnAHUAbABhAHIAVgBlAHIAcwBpAG8AbgAg" +
  "ADAALgAzADAAMwBDAGEAbgB0AGEAcgBlAGwAbAAtAFIAZQBnAHUAbABhAHIAVwBlAGkAZwBoAHQAVABoAGkAbgBMAGkAZwBoAHQA" +
  "QgBvAGwAZABFAHgAdAByAGEAIABCAG8AbABkAAMAAAAAAAD/nAAyAAAAAAAAAAAAAAAAAAAAAAAAAAACAAUAB9kMJMMRmxgAAAAA" +
  "ACYAAQAAAAwAAQAAABwAAQACwADAAAAAAABAAEAAAAAAAAACAAAAAQAAAAYBAQEDBQcJCzEKMQoyCjQKMwoAAAABAQEExuMSgZX4" +
  "dpX3XpWulYuLi4uJk4uLjYOLi4uLi4uTFwb7d5WLhouQjRcHHqBiXwwJ20/HjBcK0VnzjBcLxhMAAAAfAgABAAQACAAOABMAHAAj" +
  "AFgAXABgAGUAdACCAJIAlgDLANgA3wD9ASoBNwFJAY0BqgHCAcgBzQHRAd8B4gHqAfaNLQqMEHcB3qN2jBAWdvh2KQqNEBWlqpGV" +
  "noL7YpOGjBB2fpOJjIeNhpmQEB95w5h7YcWNEAWGf4CIf4uNjI2Hi4uNipGQEBtpeaKwhpOGj5GEkoWPEB8iCi8Kk4YuComTjBB3" +
  "RrZezZxtfZuXgHmwjxAe+QE7/QuqWccxcrKOEAf3VIWDq4+JJAqWJgorCioKEBU2Co0QFeazwNfjcKx/jIGofaZ0pZAQGviNO/yZ" +
  "smLGLnDAjhAHU2dSVWyJgoqQjIeJjY6EkBAe2/h2O1DoiZPGLo4QBvl3O8cxjBCgOAop26p6Q9/MM1DojxAT6CcKE/C09wVuua1d" +
  "IAolCvlZgZg8ChLN9wYq26l7Q9/NMlDojxAT6J77d42VKAoT8PcW+Zpws8Y8IAo7Ct7bo3ZP5Y0QAywKoCMK96mNgyEK3tujdk/l" +
  "jTUKEAP4GKZ6jBAW9T73BowQBvuP97KFWvd/94ley3iUj4mqg7RTfZKREAUszyOMEAb7bPt1WcqNg40QBT3DOIwQ+5UVPQo3CnOj" +
  "l3h/nqN0o3SXeJd4o3OjdH+el3hzopsQH6+goK+vdqBnZ3Z2Z2egdq9zon+ef55zojkKEs73Bnb4djoKiZM8CoXL+T2PiVvMt0yO" +
  "EHcBjD4K20/ljBAwCgYQd/cZ9watXUPgjRAAAAAAAQACAA4AAAAAAAAAGAACAAEAAQAFAAEAAQADAAAAEAAAABAAAAAQAAEAAAAB" +
  "AAAACgAcAB4AAURGTFQACAAEAAAAAP//AAAAAAAAAAEAAAAKADQAQgACREZMVAAObGF0bgAYAAQAAAAA//8AAAAAAAFUUksgAAoA" +
  "AP//AAEAAAABbG9jbAAIAAAAAQAAAAEABAABAAAAAQAIAAEABgABAAEAAQABAAAAAQAAAAAAFAAAAEoAAAAAAAAAAAABAAAAEAAC" +
  "AAAAIAAAADAAAQACwADAAAAAAABAAEAAAAMAAAACAAAAAeBV9TP3NQABAAAAAAABAAYEAQEBAAIAAQAAAAAACAAEACxzYnlvAAAA" +
  "A3NweW8AAAABc3RybwAAAAJ4aGd0AAAAAAABAAAADAABAAAAHAABAALAAMAAAAAAAEAAQAAABAAAAAIAAAAB/gj/Af8FAf8AAAAB" +
  "AAEACAABAAAAFAAFAAAAHAACd2dodAEAAAAACgAWACIAMgA+AAEAAAAAAQEAZAAAAAEAAAAAAQIBLAAAAAMAAAACAQMBkAAAArwA" +
  "AAABAAAAAAEEArwAAAABAAAAAAEFAyAAAAAAAAEAAAAAAAEABcAAwADqq9VVAAAAADAAILZAAEAAAAAAAQAAABAAAgABABQABQAI" +
  "d2dodABkAAABkAAAAyAAAAAAAQABAQAAAGQAAAECAAABLAAAAQMAAAGQAAABBAAAArwAAAEFAAADIAAA"
}

///|
fn cff_hint_font_notosansjp_regular_subset_otf_b64() -> String {
  "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" +
  "AHMAQwBKAEsAagBwAC0AUgBlAGcAdQBsAGEAcgBWAGUAcgBzAGkAbwBuACAAMgAuADAAMAA0ADsAaABvAHQAYwBvAG4AdgAgADEA" +
  "LgAwAC4AMQAxADgAOwBtAGEAawBlAG8AdABmAGUAeABlACAAMgAuADUALgA2ADUANgAwADMAMgAuADAAMAA0ADsARwBPAE8ARwA7" +
  "AE4AbwB0AG8AUwBhAG4AcwBDAEoASwBqAHAALQBSAGUAZwB1AGwAYQByADsAQQBEAE8AQgBFAFIAZQBnAHUAbABhAHIATgBvAHQA" +
  "bwAgAFMAYQBuAHMAIABDAEoASwAgAEoAUACpACAAMgAwADEANAAtADIAMAAyADEAIABBAGQAbwBiAGUAIAAoAGgAdAB0AHAAOgAv" +
  "AC8AdwB3AHcALgBhAGQAbwBiAGUALgBjAG8AbQAvACkALgAAAQAEBAABAQEWTm90b1NhbnNDSktqcC1SZWd1bGFyAAEBAVMcAYoc" +
  "AYuLDB4cAYcBHAGIAhwBiQMcAYQE+yoMA/5+/qwcC3AcBxAFHioAOZmV/wwfHQAA//8MIh0AAAFLDx0AAAG5ER0AAAFPDCUdAAAB" +
  "WgwkAAcBAVZufoOLqMpDb3B5cmlnaHQgMjAxNC0yMDIxIEFkb2JlIChodHRwOi8vd3d3LmFkb2JlLmNvbS8pLiBOb3RvIGlzIGEg" +
  "dHJhZGVtYXJrIG9mIEdvb2dsZSBJbmMuTm90byBTYW5zIENKSyBKUCBSZWd1bGFyTm90byBTYW5zIENKSyBKUEFkb2JlSWRlbnRp" +
  "dHlOb3RvU2Fuc0NKS2pwLVJlZ3VsYXItR2VuZXJpY05vdG9TYW5zQ0pLanAtUmVndWxhci1Qcm9wb3J0aW9uYWwAAAEAAToDAAIA" +
  "AAAAAQEAPAACAQEPHRwBjAwmHAAcHQAAAXwSHAGNDCYcACEdAAABmBL7joscBUaLBrMKswuz2wwMs9sMDYwMEfp8FPYVfpj4s5n3" +
  "RJkG+46gB9AK4AvQlZQMDOCVmwwN+XoU+P0VADwCAAEAVABVAFYAVwBYAFkAWgBbAFwAXQBeAF8AYABhAGIAYwBkAGUAZgBnAGgA" +
  "aQBqAGsAbABtAG4AbwBwAHEAcgBzAHQAdQC2ARsBZwFoAWkBagFrAWwBbQFuAW8BcAHOAhYCFwJVAlYCVwJYAlkCWgJbAlwCXQJe" +
  "AoP7DL357+ZZvRLvvflQvRO47/sMFfm0+nz9tAb4JPxfFfvS+C0F+RAG+7L8VhUT2PfS+C0F/cYH/TBiFffS+C330vwtBf0w+e8V" +
  "99L8LfvS/C0FDg4ODg4ODg4ODg4ODg4ODg4ODg4ODg4ODg4ODg4ODg4ODoKgdvd01Pf91gGP+OwDjxboBtL3dAX3oAbR+3QF7Qb7" +
  "jflxBSQGTvxIFa/3BaXeo9qi4RmPBqM2ojumOK77BRgOs4vV96jT94LUEvDn97LmWuYT9PAW930G9zj3BtL3JO9NxTScH5AHE/jQ" +
  "obHL1Br3FSO9+yge+20G5/vLFfeC9wUH9wfFazVAWF77Eh/7AfvwFfeo9xQHE/T3FdJiMChBXvsSHw6gftz46dwBxeoD+A1+FerT" +
  "sc7FH1jGBVdcVmxFG/sgM/cI9033S+j3BfceyrtvYrIfvccFumFFtjIb+077H/sj+4H7gvcc+yH3Sx8ODg4ODg4ODg4O91egdtX3" +
  "BvhG9wMB8N74TeED8Bbe+CoGyoXkhcsejwbG+zv3H/wRBckG9x74Ecb3OwWPBoZLhDJMGvwq4flx+wMH+yD8HHpZfFd4WBmHBnm+" +
  "e794vfsg+BwY+wMGDvWL9wwodvj69wuLdxLw4vfu4xNc8Bbi+BUGE2zYhNmH1R6PBtr7K/ef/GMF6vlxM/wRBhOcP5I4kUIehgY8" +
  "9yv7oPhiBS0GDg6boHb3uNb3t9YB8Of3v+cD8Bbn97j3DQb3NfcB0vcv9zT7AsL7OB/7ZQbn/AIV97f0B/cVzGogIk5d+xUfDg4O" +
  "Dg4ODg4ODn2L2vjU2QG9+I4DvRb4jtr8HAb4F/jrBcL8Zj339Af8F/zrBQ4="
}

///|
test "cff hinting: Cantarell VF (gid=1 size=16) matches fontations hinted SVG" {
  let font = cff_hint_golden_font(cff_hint_font_cantarell_vf_trimmed_b64())
  let outlines0 = OutlineGlyphCollection::from_font(font)
  let size = @moon_skrifa.Size::new(16.0)
  let loc = @moon_skrifa.LocationRef::default()
  let opts = Engine::Interpreter.into()
  let hinter = HintingInstance::new(outlines0, size, loc, opts).unwrap()
  let outlines = OutlineGlyphCollection::from_font(font)
  let glyph = outlines.get(@moon_skrifa.GlyphId::new((1).to_uint16())).unwrap()
  let pen = SvgPen::with_precision(6)
  glyph
  .draw(
    DrawSettings::hinted(hinter, false).with_path_style(PathStyle::FreeType),
    pen,
  )
  .unwrap()
  |> ignore
  inspect(
    pen.to_string(),
    content="M1.328125,0.000000 L2.593750,0.000000 L2.593750,8.000000 L1.328125,8.000000 Z M1.984375,10.000000 C2.546875,10.000000 2.890625,10.328125 2.890625,10.906250 C2.890625,11.484375 2.546875,11.812500 1.984375,11.812500 C1.406250,11.812500 1.062500,11.484375 1.062500,10.906250 C1.062500,10.328125 1.406250,10.000000 1.984375,10.000000 Z",
  )
}

///|
test "cff hinting: NotoSansJP-Regular subset (gid=0 size=16) matches fontations hinted SVG" {
  let font = cff_hint_golden_font(
    cff_hint_font_notosansjp_regular_subset_otf_b64(),
  )
  let outlines0 = OutlineGlyphCollection::from_font(font)
  let size = @moon_skrifa.Size::new(16.0)
  let loc = @moon_skrifa.LocationRef::default()
  let opts = Engine::Interpreter.into()
  let hinter = HintingInstance::new(outlines0, size, loc, opts).unwrap()
  let outlines = OutlineGlyphCollection::from_font(font)
  let glyph = outlines.get(@moon_skrifa.GlyphId::new((0).to_uint16())).unwrap()
  let pen = SvgPen::with_precision(6)
  glyph
  .draw(
    DrawSettings::hinted(hinter, false).with_path_style(PathStyle::FreeType),
    pen,
  )
  .unwrap()
  |> ignore
  inspect(
    pen.to_string(),
    content="M1.593750,-2.000000 L14.390625,-2.000000 L14.390625,14.000000 L1.593750,14.000000 Z M8.000000,6.656250 L2.906250,13.187500 L13.078125,13.187500 Z M8.500000,6.000000 L13.593750,12.531250 L13.593750,-0.546875 Z M2.906250,-1.203125 L8.000000,5.343750 L13.078125,-1.203125 Z M2.390625,12.531250 L7.484375,6.000000 L2.390625,-0.546875 Z",
  )
}
