// Copyright 2025 International Digital Economy Academy
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

///|
/// Golden outline tests against `fontations-reference` (skrifa).
///
/// Fixtures are sourced from `fontations-reference/font-test-data` and embedded
/// as base64 strings to keep tests hermetic.
fn font_vazirmatn_var_trimmed_b64() -> String {
  "AAEAAAAOAIAAAwBgSFZBUo9SovEAAAK8AAAAUFNUQVR7w21TAAADDAAAAEZhdmFyagtAAQAAA1QAAAAuY21hcABwAU4AAAF4AAAA" +
  "PGZ2YXKXxGmTAAADhAAAAGxnYXNwAAAAEAAAArQAAAAIZ2x5ZqJoZ1cAAAHAAAAAhmd2YXJFUAL3AAAD8AAAAMBoZWFkGTap1wAA" +
  "AOwAAAA2aGhlYQ1xAQsAAAEkAAAAJGhtdHgQdQDXAAABaAAAABBsb2NhAGUANAAAAbQAAAAKbWF4cAI5Dv4AAAFIAAAAIG5hbWUI" +
  "cRj5AAACSAAAAGwAAQAAAAAAAMR0H2NfDzz1AA8IAAAAAADRff30AAAAAONcX7EAHQAABR4HNwAAAAYAAgAAAAAAAAABAAAINPu0" +
  "AAAFOAAdABoFHgABAAAAAAAAAAAAAAAAAAAABAABAAAABAAOAAMAEgAEAAIAegDPAI0AAAEkDgwAAgABA4wAZAU4AB0FOAAdAnkA" +
  "OQAAAAEAAAADAAAADAAEADAAAAAIAAgAAgAAAEEAYADA//8AAABBAGAAwP///8D/o/9CAAEAAAAAAAAAAAAAAAAAIgA0AEMAAAAD" +
  "AB0AAAUeBbAABAAJAA0AAAEBIwEzAQEnMwEDFSE1AsT+HsUCK38Bkf4dA38CLd/8zgUv+tEFsPpQBS+B+lACG56e//8AHQAABR4H" +
  "NwImAAEAAAUHAAMBLwE3AAmxAwG4ATewNSsAAAEAOQTaAdoGAAADAABBEyMBARnBn/7+BgD+2gEmAAAAAAAFAEIAAwABBAkAAgAO" +
  "AAAAAwABBAkBAQAMAA4AAwABBAkBAgAIABoAAwABBAkBBQAOAAAAAwABBAkBCAAIACIAUgBlAGcAdQBsAGEAcgBXAGUAaQBnAGgA" +
  "dABUAGgAaQBuAEIAbwBsAGQAAQAB//8ADwABAAAAAAAUAAAASAAAAAAAAAAAAAEAAAAQAAIAAAAgAAAAJgABAALAAMAAAAAAAEAA" +
  "QAAAAQAAAAAAAgAAAAIAAAABjzugPwAAAAQAAgIDAAEAAQAIAAEAAAAUAAMAAAAcAAJ3Z2h0AQEAAAAGABIAHgABAAAAAAECAGQA" +
  "AAABAAAAAgEFAZAAAAABAAAAAAEIArwAAAAAAAEAAAAAAAEACcAAwADVVeAA6qvwAAAAAAAMzReDGZohcCZmK10zMzWuQABAAAAA" +
  "AAEAAAAQAAIAAQAUAAkACHdnaHQAZAAAAZAAAAOEAAAAAAEBAQIAAABkAAABAwAAAMgAAAEEAAABLAAAAQUAAAGQAAABBgAAAfQA" +
  "AAEHAAACWAAAAQgAAAK8AAABCQAAAyAAAAEKAAADhAAAAAEAAAABAAIAAAAeAAQAAAAAACIAAAAAACwAOgBPQADAAIACAAwAJAAB" +
  "ACYAAAAApkD/eg0E+q8S59+Th5GR6uoAj4EAU4QAU4IDzjY2zoEB6wAAFEAAkw3fyzumJfptWrGx+PgAO4FA/0+EQP9PggMEk5ME" +
  "gQEJAACAAgAMAAYAAQAGAAACAQECAc2PAQgAAco7Af8AgAIADAANAAEAEAAAAAW+uR1cAKCBgAEcHIRBAIIAiAMW/gA/gYAB7OyE"
}

///|
fn font_notosansjp_vf_subset_otf_b64() -> String {
  "T1RUTwAVAQAABABQQkFTRXybflQAAAdUAAABFkNGRjIN2Xc1AAAORAAABFFHREVGTFg3KgAAAmwAAAA4R1BPU9kH4n0AAAhsAAAB" +
  "mEdTVULQssykAAACpAAAAEZIVkFSq9zZTQAABAQAAAC2T1MvMlU2sx8AAAM4AAAAYFNUQVSA55G2AAAEvAAAALZWT1JHA3EAAAAA" +
  "AWQAAAAIVlZBUg4BFE4AAAIAAAAAM2F2YXKNe4wBAAAB1AAAACpjbWFwAScBVgAAAuwAAABMZnZhcouKdXgAAAOYAAAAamhlYWQg" +
  "C98vAAACNAAAADZoaGVhDB4IzgAAAYwAAAAkaG10eBVpAp4AAAV0AAAA8G1heHAAPFAAAAABXAAAAAZuYW1lfNu6hgAACgQAAARA" +
  "cG9zdP+GADIAAAFsAAAAIHZoZWEMvhd4AAABsAAAACR2bXR4H0AEKQAABmQAAADwAABQAAA8AAAAAQAAA3AAAAADAAAAAAAA/4MA" +
  "MgAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAASI/uAAAAu4/CH9+QtyAAEAAAAAAAAAAAAAAAAAAAA8AAEQAAH0/gwAAAu4/1T9eAty" +
  "AAAAAQAAAAAAAAAAAAAAAAA8AAEAAAAAAAEACMAAwAAAAAAAEAAKPRQAFHsYABj2IAAj1zAAMexAAEAAAAAAAQAAAAAAHQAAABgA" +
  "AAAAAAAAAAAAABgAAAABAAABAAAAEgABAAAADAABAAAAAAABAAAAAAEAAAACAQag8FCTXw889QADA+gAAAAA3LCLqQAAAADcsA6o" +
  "/CH75gtyBxIAAAADAAIAAAAAAAAAAQADAAAAAAAAAAAAAAAAABIAAQAAABwAAQAAAAwACAAAAAEAAO31/v8JCw03AAEAAQAAQABA" +
  "AAABAAAACgBEAEQAB0RGTFQAMGN5cmwALGdyZWsALGhhbmcALGhhbmkALGthbmEALGxhdG4ALAAAAAAABAAAAAD//wAAAAAAAAAA" +
  "AAIAAAADAAAAFAADAAEAAAAUAAQAOAAAAAoACAACAAIAQwBOAFAAWv//AAAAQQBNAFAAWv///+H/4f/h/+EAAQAAAAAAAAAAAAAA" +
  "AwPTAGQABQAAAooCWAAAAEsCigJYAAABXgAyAUUAAAILAgAAAAAAAAAAAAABAAAAAAAAAAAAAAAAQURCTwAAAEEAWgNw/4gAAASI" +
  "ASBgLgEHAAAAAAIfAt0AAAAgAAYAAQAAABAAAgABABQABwAKd2dodABkAAAAZAAAA4QAAAAAAQkBCgAAAGQAAAELAQwAAAEsAAAB" +
  "DQEOAAABXgAAAQ8BEAAAAZAAAAERARIAAAH0AAABEwEUAAACvAAAARUBFgAAA4QAAAEXAAAAAQAAAAAAkAAAABQAAAAAAAAAAAAS" +
  "ADwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAIA" +
  "AwAAAAAAAAAAAAAAAAAAAAAAAAAEAAUAAAAGAAAAAAAAAAAAAAAAAAAAAAAAAAcAAQAAABwAAQAAAAwACAAAAAEAAABWPzBrRFkb" +
  "AAEAAQAAQABAAAAAAAEAAQAIAAEAAAAUAAcAAAAcAQB3Z2h0AQkAAAAOACIANgBKAF4AcgCGAAIAAAAAAQIAZAAAAGQAAADHAAAA" +
  "AgAAAAABAwEsAAAAyAAAAV0AAAACAAAAAAEEAV4AAAFeAAABjwAAAAIAAAACAQUBkAAAAZAAAAHzAAAAAgAAAAABBgH0AAAB9AAA" +
  "AooAAAACAAAAAAEHArwAAAKKAAADIAAAAAIAAAAAAQgDhAAAAyAAAAOEAAAAAAPoAGQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" +
  "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" +
  "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACPgALAngAbgJrAD4AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" +
  "AAAAAAADAgBuArgAbgAAAAACVgBuAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAlAAOQPoAAAAAAAAAAAAAAAA" +
  "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" +
  "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD6ACaA+gAmgPoAI0AAAAAAAAAAAAAAAAAAAAA" +
  "AAAAAAAAAAAAAAAAAAAAAAAAAAAD6ACaA+gAmgAAAAAD6ACaAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA+gA" +
  "mgABAAEAcAAMAAAA9gDYAAQAB0RGTFQAPmN5cmwALGdyZWsALGhhbmcAPmhhbmkAPmthbmEAPmxhdG4ALAAGAAAAAAADAAQAKAAi" +
  "AIIAHgAGAAAAAAACAAQAFgAQAHAADAABAHgAAwOzAG4AAwA1AHQAdAAEAAdERkxUAD5jeXJsACxncmVrACxoYW5nAD5oYW5pAD5r" +
  "YW5hAD5sYXRuACwABgAAAAAAAwAEADIAJgAiAB4ABgAAAAAAAgAEACAAFAAQAAwAAQAAAAH/iAADAzsABgAAAAGAAAAD/70ABgAA" +
  "AACAAAAEaWNmYmljZnRpZGVvcm9tbgABAAAAFgABAAAADAACAAAAAQAA5RsAAQABAABAAEAAAAAAAQAAAAoAigC8AAdERkxUAHRj" +
  "eXJsAGhncmVrAFxoYW5nAFBoYW5pAERrYW5hADhsYXRuACwABAAAAAD//wABAAYABAAAAAD//wABAAUABAAAAAD//wABAAQABAAA" +
  "AAD//wABAAMABAAAAAD//wABAAIABAAAAAD//wABAAEABAAAAAD//wABAAAAB2tlcm4ALGtlcm4ALGtlcm4ALGtlcm4ALGtlcm4A" +
  "LGtlcm4ALGtlcm4ALAAAAAEAAAABAAQAAgAAAAEACAACAGAARAAAALQAngAFAAQAAAAA//UAmP/1AJL/8wCMAAAAAP/oAIYAAAAA" +
  "//UAmAAAAAAAAAAAAAAAAAAAAIAAAAAAAAAAAP/JAHr/kwB0AAAAAP/qAJj/9QCS/+oAbgABAAUAIgAjACQAMQA7AAAABIAAAAAA" +
  "B4AAAAAAAoAAAAAAAYAAAAAAAIAAAAAABoAAAAAABYAAAAAAA4AAAAIAAwAiACIAAgAkACQAAQA7ADsAAwACAAQAIwAjAAIAJAAk" +
  "AAEAMQAxAAMAOwA7AAQAAAAeAW4AAwABBAkAAACYAjoAAwABBAkAAQAgAhoAAwABBAkAAgAOAgwAAwABBAkAAwBGAcYAAwABBAkA" +
  "BAAgAhoAAwABBAkABQBkAWIAAwABBAkABgAkAT4AAwABBAkBAAAOAgwAAwABBAkBAgAIATYAAwABBAkBAwAKASwAAwABBAkBBAAS" +
  "ARoAAwABBAkBBQAOAgwAAwABBAkBBgAMAQ4AAwABBAkBBwAIAQYAAwABBAkBCAAKAPwAAwABBAkBCQAMAPAAAwABBAkBCgAIATYA" +
  "AwABBAkBCwAkAT4AAwABBAkBDAAKASwAAwABBAkBDQAmAMoAAwABBAkBDgASARoAAwABBAkBDwAuAJwAAwABBAkBEAAOAgwAAwAB" +
  "BAkBEQAqAHIAAwABBAkBEgAMAQ4AAwABBAkBEwAoAEoAAwABBAkBFAAIAQYAAwABBAkBFQAkACYAAwABBAkBFgAKAPwAAwABBAkB" +
  "FwAmAAAATgBvAHQAbwBTAGEAbgBzAEMASgBLAGoAcAAtAEIAbABhAGMAawBOAG8AdABvAFMAYQBuAHMAQwBKAEsAagBwAC0AQgBv" +
  "AGwAZABOAG8AdABvAFMAYQBuAHMAQwBKAEsAagBwAC0ATQBlAGQAaQB1AG0ATgBvAHQAbwBTAGEAbgBzAEMASgBLAGoAcAAtAFIA" +
  "ZQBnAHUAbABhAHIATgBvAHQAbwBTAGEAbgBzAEMASgBLAGoAcAAtAEQAZQBtAGkATABpAGcAaAB0AE4AbwB0AG8AUwBhAG4AcwBD" +
  "AEoASwBqAHAALQBMAGkAZwBoAHQAVwBlAGkAZwBoAHQAQgBsAGEAYwBrAEIAbwBsAGQATQBlAGQAaQB1AG0ARABlAG0AaQBMAGkA" +
  "ZwBoAHQATABpAGcAaAB0AFQAaABpAG4ATgBvAHQAbwBTAGEAbgBzAEMASgBLAGoAcAAtAFQAaABpAG4AVgBlAHIAcwBpAG8AbgAg" +
  "ADIALgAwADAANAA7AGgAbwB0AGMAbwBuAHYAIAAxAC4AMAAuADEAMQA4ADsAbQBhAGsAZQBvAHQAZgBlAHgAZQAgADIALgA1AC4A" +
  "NgA1ADYAMAAzADIALgAwADAANAA7AEEARABCAE8AOwBOAG8AdABvAFMAYQBuAHMAQwBKAEsAagBwAC0AVABoAGkAbgA7AEEARABP" +
  "AEIARQBSAGUAZwB1AGwAYQByAE4AbwB0AG8AIABTAGEAbgBzACAAQwBKAEsAIABKAFAAqQAgADIAMAAxADQALQAyADAAMgAxACAA" +
  "QQBkAG8AYgBlACAAKABoAHQAdABwADoALwAvAHcAdwB3AC4AYQBkAG8AYgBlAC4AYwBvAG0ALwApACwAIAB3AGkAdABoACAAUgBl" +
  "AHMAZQByAHYAZQBkACAARgBvAG4AdAAgAE4AYQBtAGUAIAAnAFMAbwB1AHIAYwBlACcALgIABQAaHQAAAF0MJR0AAABDDCQdAAAA" +
  "jxEdAAAAIxgAAAAAAB4AAQAAAAwAAQAAABYAAQABAABAAEAAAAAAAAABAAAAAAACAQEKExwAFR0AAABoEhwAEh0AAAB9EgMAAgAA" +
  "AAABAQA8+46LHQAABUaLBq4KpwunnQwNjAwR+46LHQAABUaLBq4KpwunnQwNAAAAPAIAAQBBAEEAQQBBAEEAQQBBAEEAQQBBAEEA" +
  "QQBBAEEAQQBBAEEAQQBBAEEAQQBBAEEAQQBBAEEAQQBBAEEAQQBBAEEAQQBBAKEBOwG2AbYBtgG2AbYBtgG2AbYBtgG2Ak4CtQK1" +
  "Aw4DDgMOAw4DDgMOAw4DDgMOAw4DRO/7DBX5tPp8/bQG+CT8XxX70vgtBfkQBvuy/FYV99L4LQX9xgf9MGIV99L4LffS/C0F/TD5" +
  "7xX30vwt+9L8LQWWeIwQFrD3JYwQBvct+Eeq46XVpuZPTH99hZiCfpMQGY8GpjCkQaozhJqFfICZkRAI9yv8R7NRyvcojhCL+5j5" +
  "aqiejRAFavtJjBAG+yf8aNQhjRAV99ir+9iv9WeOEAb3AnOMEBb3X9mMEAb3OfPU9x7wS8crmoikhpmJkoegkJQQH5CKjBAH1qGy" +
  "xth8jImYgJAQGvcMMMP7JaJrfYKPEB77UkWMEAaw+9b3IqWNEBX3tvce+xdLjRAH9yDUZCAxTVX7MkplnMGyp6DdkxAf+xf8B8TG" +
  "jRAV9+b3LfsxS40QB/cv5Vf7AvsOLVX7K0dcprzFvaLMkxAf9/5+soqNEBXpy7LLwo6eiZSTkBAfdKNE440QBU5UUmw/op+VjJuQ" +
  "EBv7Nib3G/dk92Tw9xf3Os/CbF6yxKxaT0x1XkV8e5KWipgQH6Kk0eSNEAW3Zku1N5N9fY5+kBAb+0z7Dvsl+3n7efcN+yn3R4Zf" +
  "jnh0sp6VkxAf9wJzjBAWrviK9xH7i40QBsSJ1YjGnH+whZmQEB6PBsT7NPc4/FeyjnlM90fGkBCL9zf4V8P3NEz7R5GdjxAFj4yM" +
  "EAaJUIlBUoN9f2Z6kBAa/Iqw+WpQ94v3Ep77G48QB/sw/Ep4VXlUd1S19wiQlpGTkJWTEBmHiowQBnfCd8J3wfsv+EqRgZODkICw" +
  "+wiTEBhQ+xqMEAb3AnOMEBau+G33G/t2jRAG0InJic+gfrOFmpAQHo+MjBAG3vsj99P8pYF3+xv3Po8QBbP5amf8Z/cinvsa93CP" +
  "EAZHjUiPRXaYY5CCkBAehgY49yP71PillaH3G/tAjxAFZPsjjBAG9wJzjBAWsPfU9yL3IkJUjhAG9zfoz/cg9yUswPs5hraVsLJj" +
  "kY2TEB/7QzSMEAaw/An3IpuNEBX36PcR+xFXjRAH9zHXZfsT+xFBWfsvRG+Xv7+rlM+TEB/EeYwQFvh1rPxGyvcJ9wKOEAb4Qfk0" +
  "+wD7TY0QBaD8Smr4G+JD+wgmjxAH/EH9M/cA90uNEAUAAAA="
}

///|
fn b64_val(c : Int) -> Int? {
  if c >= 65 && c <= 90 {
    Some(c - 65)
  } else if c >= 97 && c <= 122 {
    Some(c - 97 + 26)
  } else if c >= 48 && c <= 57 {
    Some(c - 48 + 52)
  } else if c == 43 {
    Some(62)
  } else if c == 47 {
    Some(63)
  } else {
    None
  }
}

///|
fn b64_decode(s : String) -> Bytes {
  let out : Array[Byte] = Array::new()
  let vals : Array[Int] = Array::new()
  let n = s.length()
  for i in 0..<n {
    let c = s.code_unit_at(i).to_int()
    if c == 61 {
      // "=" padding
      vals.push(-1)
    } else {
      match b64_val(c) {
        None => ()
        Some(v) => vals.push(v)
      }
    }
    if vals.length() == 4 {
      let v0 = vals.at(0)
      let v1 = vals.at(1)
      let v2 = vals.at(2)
      let v3 = vals.at(3)
      out.push((((v0 << 2) | (v1 >> 4)) & 0xFF).to_byte())
      if v2 != -1 {
        out.push(((((v1 & 0x0F) << 4) | (v2 >> 2)) & 0xFF).to_byte())
        if v3 != -1 {
          out.push(((((v2 & 0x03) << 6) | v3) & 0xFF).to_byte())
        }
      }
      vals.clear()
    }
  }
  Bytes::from_array(out.op_as_view())
}

///|
fn golden_font(b64 : String) -> @moon_skrifa.FontRef {
  @moon_skrifa.FontRef::new(b64_decode(b64)).unwrap()
}

///|
test "golden: glyf Vazirmatn gid=2 size=16 ft coords=0" {
  let font = golden_font(font_vazirmatn_var_trimmed_b64())
  let outlines = OutlineGlyphCollection::from_font(font)
  let glyph = outlines.get(@moon_skrifa.GlyphId::new((2).to_uint16())).unwrap()
  let coords : Array[@moon_skrifa.NormalizedCoord] = Array::from_fixed_array([0])
  let settings = DrawSettings::unhinted(
    @moon_skrifa.Size::new(16.0),
    @moon_skrifa.LocationRef::new(coords.op_as_view()),
  ).with_path_style(PathStyle::FreeType)
  let pen = SvgPen::with_precision(3)
  glyph.draw(settings, pen).unwrap() |> ignore
  inspect(
    pen.to_string(),
    content="M5.531,10.375 L1.766,0.000 L0.234,0.000 L4.562,11.375 L5.562,11.375 Z M8.688,0.000 L4.922,10.375 L4.891,11.375 L5.891,11.375 L10.234,0.000 Z M8.500,4.219 L8.500,2.984 L2.109,2.984 L2.109,4.219 Z M4.578,14.438 L6.078,12.141 L4.844,12.141 L2.828,14.438 Z",
  )
}

///|
test "golden: glyf Vazirmatn gid=2 size=16 ft coords=0.5" {
  let font = golden_font(font_vazirmatn_var_trimmed_b64())
  let outlines = OutlineGlyphCollection::from_font(font)
  let glyph = outlines.get(@moon_skrifa.GlyphId::new((2).to_uint16())).unwrap()
  let coords : Array[@moon_skrifa.NormalizedCoord] = Array::from_fixed_array([
    8192,
  ])
  let settings = DrawSettings::unhinted(
    @moon_skrifa.Size::new(16.0),
    @moon_skrifa.LocationRef::new(coords.op_as_view()),
  ).with_path_style(PathStyle::FreeType)
  let pen = SvgPen::with_precision(3)
  glyph.draw(settings, pen).unwrap() |> ignore
  inspect(
    pen.to_string(),
    content="M5.609,9.672 L2.344,0.000 L0.094,0.000 L4.359,11.375 L5.781,11.375 Z M8.344,0.000 L5.062,9.672 L4.875,11.375 L6.312,11.375 L10.594,0.000 Z M8.188,4.234 L8.188,2.547 L2.078,2.547 L2.078,4.234 Z M4.859,14.438 L6.391,12.062 L4.703,12.062 L2.594,14.438 Z",
  )
}

///|
test "golden: glyf Vazirmatn gid=2 size=16 hb coords=0 (16.16 fixed)" {
  let font = golden_font(font_vazirmatn_var_trimmed_b64())
  let outlines = OutlineGlyphCollection::from_font(font)
  let glyph = outlines.get(@moon_skrifa.GlyphId::new((2).to_uint16())).unwrap()
  let coords : Array[@moon_skrifa.NormalizedCoord] = Array::from_fixed_array([0])
  let settings = DrawSettings::unhinted(
    @moon_skrifa.Size::new(16.0),
    @moon_skrifa.LocationRef::new(coords.op_as_view()),
  ).with_path_style(PathStyle::HarfBuzz)
  let pen = SvgPen::with_precision(3)
  glyph.draw(settings, pen).unwrap() |> ignore
  inspect(
    pen.to_string(),
    content="M362496.000,679424.000 L115712.000,0.000 L14848.000,0.000 L299008.000,745472.000 L364032.000,745472.000 Z M569344.000,0.000 L322048.000,679424.000 L320512.000,745472.000 L385536.000,745472.000 L670720.000,0.000 Z M556544.000,275968.000 L556544.000,195072.000 L137728.000,195072.000 L137728.000,275968.000 Z M144175.000,786743.000 L242991.000,636215.000 L161583.000,636215.000 L29487.000,786743.000 Z",
  )
}

///|
test "golden: glyf Vazirmatn gid=2 size=16 hb coords=0.5 (16.16 fixed)" {
  let font = golden_font(font_vazirmatn_var_trimmed_b64())
  let outlines = OutlineGlyphCollection::from_font(font)
  let glyph = outlines.get(@moon_skrifa.GlyphId::new((2).to_uint16())).unwrap()
  let coords : Array[@moon_skrifa.NormalizedCoord] = Array::from_fixed_array([
    8192,
  ])
  let settings = DrawSettings::unhinted(
    @moon_skrifa.Size::new(16.0),
    @moon_skrifa.LocationRef::new(coords.op_as_view()),
  ).with_path_style(PathStyle::HarfBuzz)
  let pen = SvgPen::with_precision(3)
  glyph.draw(settings, pen).unwrap() |> ignore
  inspect(
    pen.to_string(),
    content="M367616.000,634112.000 L153344.000,0.000 L6400.000,0.000 L285440.000,745472.000 L379136.000,745472.000 Z M546304.000,0.000 L331520.000,634112.000 L318976.000,745472.000 L413440.000,745472.000 L693760.000,0.000 Z M536320.000,276992.000 L536320.000,167168.000 L135680.000,167168.000 L135680.000,276992.000 Z M177428.000,786742.500 L277780.000,631094.500 L167188.000,631094.500 L28948.000,786742.500 Z",
  )
}

///|
test "golden: CFF2 NotoSansJP-VF gid=0 size=16" {
  let font = golden_font(font_notosansjp_vf_subset_otf_b64())
  let outlines = OutlineGlyphCollection::from_font(font)
  let glyph = outlines.get(@moon_skrifa.GlyphId::new((0).to_uint16())).unwrap()
  let settings = DrawSettings::unhinted(
    @moon_skrifa.Size::new(16.0),
    @moon_skrifa.LocationRef::default(),
  ).with_path_style(PathStyle::FreeType)
  let pen = SvgPen::with_precision(3)
  glyph.draw(settings, pen).unwrap() |> ignore
  inspect(
    pen.to_string(),
    content="M1.594,-1.922 L14.406,-1.922 L14.406,14.078 L1.594,14.078 Z M8.000,6.734 L2.906,13.281 L13.094,13.281 Z M8.516,6.078 L13.594,12.625 L13.594,-0.469 Z M2.906,-1.125 L8.000,5.422 L13.094,-1.125 Z M2.406,12.625 L7.484,6.078 L2.406,-0.469 Z",
  )
}
